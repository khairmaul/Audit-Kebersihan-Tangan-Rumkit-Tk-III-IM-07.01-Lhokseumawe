<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Hand Hygiene - Pro Edition 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library Ekspor -->
    <script src="https://cdnjs.cloudflare.com"></script>
    <script src="https://cdnjs.cloudflare.com"></script>
    <script src="https://cdnjs.cloudflare.com"></script>
</head>
<body class="bg-gray-100 min-h-screen pb-10">

    <div class="max-w-3xl mx-auto p-4">
        <!-- Card Utama -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200">
            <div class="bg-blue-700 p-6 text-white text-center">
                <h1 class="text-2xl font-bold">Audit Kebersihan Tangan</h1>
		<h1 class="text-2xl font-bold">Rumah Sakit Tk III IM 07.01 Lhokseumawe</h1>
                <p class="opacity-80 text-sm">Standar PPI - WHO 5 Moments</p>
            </div>

            <div class="p-6 space-y-4">
                <!-- Identitas -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="auditor" placeholder="Nama Auditor" class="border p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    <input type="text" id="unit" placeholder="Unit/Ruangan" class="border p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="staff" placeholder="Nama Petugas Diamati" class="border p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    <select id="profession" class="border p-3 rounded-lg bg-white outline-none">
                        <option value="">-- Pilih Profesi --</option>
                        <option value="Dokter">Dokter</option>
                        <option value="Perawat">Perawat</option>
                        <option value="Bidan">Bidan</option>
                        <option value="Tenaga Medis Lain">Tenaga Medis Lain</option>
                        <option value="Non-Medis">Non-Medis/CS</option>
                    </select>
                </div>

                <hr class="my-4">

                <!-- 5 Moments -->
                <h3 class="font-bold text-gray-700">Indikasi Kepatuhan:</h3>
                <div id="momentsContainer" class="space-y-3">
                    <label class="flex justify-between items-center p-3 border rounded-xl hover:bg-blue-50 transition cursor-pointer">
                        <span class="text-sm pr-4">1. Sebelum kontak pasien</span>
                        <input type="checkbox" class="compliance-box w-6 h-6 accent-blue-600">
                    </label>
                    <label class="flex justify-between items-center p-3 border rounded-xl hover:bg-blue-50 transition cursor-pointer">
                        <span class="text-sm pr-4">2. Sebelum tindakan aseptik</span>
                        <input type="checkbox" class="compliance-box w-6 h-6 accent-blue-600">
                    </label>
                    <label class="flex justify-between items-center p-3 border rounded-xl hover:bg-blue-50 transition cursor-pointer">
                        <span class="text-sm pr-4">3. Setelah terkena dengan cairan tubuh pasien</span>
                        <input type="checkbox" class="compliance-box w-6 h-6 accent-blue-600">
                    </label>
                    <label class="flex justify-between items-center p-3 border rounded-xl hover:bg-blue-50 transition cursor-pointer">
                        <span class="text-sm pr-4">4. Setelah kontak dengan pasien</span>
                        <input type="checkbox" class="compliance-box w-6 h-6 accent-blue-600">
                    </label>
                    <label class="flex justify-between items-center p-3 border rounded-xl hover:bg-blue-50 transition cursor-pointer">
                        <span class="text-sm pr-4">5. Setelah kontak lingkungan pasien</span>
                        <input type="checkbox" class="compliance-box w-6 h-6 accent-blue-600">
                    </label>
                </div>

                <!-- Action Buttons -->
                <div class="grid grid-cols-1 gap-3 pt-4">
                    <button onclick="submitAudit()" id="btnSubmit" class="bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-blue-800 transition uppercase tracking-wider">
                        Simpan & Kirim Data
                    </button>
                    <div class="flex gap-2">
                        <button onclick="exportToExcel()" class="flex-1 bg-green-600 text-white py-3 rounded-lg text-sm font-semibold hover:bg-green-700">
                            Ekspor Riwayat (Excel)
                        </button>
                        <button onclick="downloadLastPDF()" class="flex-1 bg-red-500 text-white py-3 rounded-lg text-sm font-semibold hover:bg-red-600">
                            Cetak PDF Terakhir
                        </button>
                    </div>
                </div>
                <p id="statusMsg" class="text-center text-sm font-medium"></p>
            </div>
        </div>

        <!-- Tabel Riwayat Sederhana -->
        <div class="mt-8 bg-white p-4 rounded-xl shadow border">
            <h3 class="font-bold mb-3 text-gray-700">Riwayat Audit (Sesi Ini)</h3>
            <div class="overflow-x-auto">
                <table id="historyTable" class="w-full text-xs text-left border-collapse">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-2 border">Petugas</th>
                            <th class="p-2 border">Profesi</th>
                            <th class="p-2 border">Skor</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // GANTI DENGAN URL WEB APP GOOGLE ANDA
        const APPS_SCRIPT_URL = "URL_WEB_APP_ANDA_DISINI";

        let localLogs = JSON.parse(localStorage.getItem('auditLogs')) || [];

        function submitAudit() {
            const auditor = document.getElementById('auditor').value;
            const unit = document.getElementById('unit').value;
            const staff = document.getElementById('staff').value;
            const profession = document.getElementById('profession').value;
            const btn = document.getElementById('btnSubmit');
            const statusMsg = document.getElementById('statusMsg');

            if (!auditor || !staff || !profession) {
                alert("Mohon lengkapi Nama Auditor, Petugas, dan Profesi!");
                return;
            }

            btn.disabled = true;
            statusMsg.innerText = "⏳ Sedang mengirim data...";
            statusMsg.className = "text-center text-sm font-medium text-blue-600";

            const checks = document.querySelectorAll('.compliance-box');
            let done = 0;
            checks.forEach(c => { if(c.checked) done++; });
            const scoreNum = (done / 5) * 100;

            const data = {
                timestamp: new Date().toLocaleString('id-ID'),
                auditor,
                unit,
                staff,
                profession,
                score: scoreNum.toFixed(1) + "%",
                status: scoreNum >= 85 ? "PATUH" : "TIDAK PATUH"
            };

            // Simpan ke Google Sheets
            fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(data)
            }).then(() => {
                statusMsg.innerText = "✅ Data Berhasil Terkirim ke Pusat!";
                statusMsg.className = "text-center text-sm font-medium text-green-600";
                
                // Simpan ke Riwayat Lokal
                localLogs.unshift(data);
                localStorage.setItem('auditLogs', JSON.stringify(localLogs));
                
                renderHistory();
                resetForm();
                btn.disabled = false;
            }).catch(err => {
                alert("Gagal mengirim ke server. Data tetap tersimpan di riwayat lokal.");
                btn.disabled = false;
            });
        }

        function renderHistory() {
            const container = document.getElementById('historyBody');
            container.innerHTML = localLogs.slice(0, 5).map(item => `
                <tr class="border-b">
                    <td class="p-2">${item.staff}</td>
                    <td class="p-2">${item.profession}</td>
                    <td class="p-2 font-bold ${parseFloat(item.score) >= 85 ? 'text-green-600' : 'text-red-600'}">${item.score}</td>
                </tr>
            `).join('');
        }

        function resetForm() {
            document.getElementById('staff').value = '';
            document.getElementById('profession').value = '';
            document.querySelectorAll('.compliance-box').forEach(c => c.checked = false);
        }

        function exportToExcel() {
            if (localLogs.length === 0) return alert("Belum ada data!");
            const ws = XLSX.utils.json_to_sheet(localLogs);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "AuditHH");
            XLSX.writeFile(wb, `Laporan_Audit_HH_${new Date().toLocaleDateString()}.xlsx`);
        }

        function downloadLastPDF() {
            if (localLogs.length === 0) return alert("Belum ada data!");
            const item = localLogs[0];
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.text("LAPORAN INDIVIDU AUDIT KEBERSIHAN TANGAN", 20, 20);
            
            doc.autoTable({
                startY: 30,
                theme: 'grid',
                body: [
                    ["Waktu", item.timestamp],
                    ["Auditor", item.auditor],
                    ["Unit", item.unit],
                    ["Nama Petugas", item.staff],
                    ["Profesi", item.profession],
                    ["Skor Kepatuhan", item.score],
                    ["Keterangan", item.status]
                ],
            });
            
            doc.save(`Audit_${item.staff}_${item.profession}.pdf`);
        }

        // Jalankan saat load
        renderHistory();
    </script>
</body>
</html>